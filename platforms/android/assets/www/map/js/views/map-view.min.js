suApp.view.MapView=Backbone.View.extend({map:null,infoWindowView:null,searchHiddenFromToolbar:!1,keyboardVisible:!1,resizeTimeout:!1,initialize:function(a){_.bindAll(this,"render","updateCurrentPosition","handleMapZoomChange","removeAllMarkers","addMarkers");this.pointViews=[];this.infoWindowView=new suApp.view.InfoWindowView({mapView:this,appModel:a.appModel});a={zoom:15,center:this.model.get("location"),mapTypeControl:!1,navigationControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:google.maps.MapTypeId.ROADMAP,
streetViewControl:!1,panControl:!1,zoomControl:!1,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]};this.map=new google.maps.Map(this.el,a);var b=this;google.maps.event.addListener(this.map,"zoom_changed",this.handleMapZoomChange);this.on("updateCurrentPosition",this.updateCurrentPosition);this.model.on("change:mapPosition",this.updateMapPosition,this);this.model.on("change:zoom",this.updateMapZoom,this);$(window).on("resize.mapview",_.bind(this.resize,this));$(document).on("showkeyboard.mapview",
function(){b.keyboardVisible=!0});$(document).on("hidekeyboard.mapview",function(){window.setTimeout(function(){b.keyboardVisible=!1;b.resize()},150)})},remove:function(){$(window).off(".mapview");$(document).off(".mapview");this.infoWindowView.remove();Backbone.View.prototype.remove.call(this)},render:function(){this.resize()},resize:function(){var a=this;clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(function(){a.keyboardVisible||($("#map-content").height($(window).height()-$("[data-role\x3d'header']").outerHeight()-
$("div#search-box").outerHeight()-2),google.maps.event.trigger(a.map,"resize"))},150)},createPositionMarker:function(){var a=new suApp.model.Location({id:-100,campus:null,type:"current_position",name:i18n.t("map.current_position.name",{lng:"sv"}),nameEn:i18n.t("map.current_position.name",{lng:"en"}),coords:[[this.model.get("location").lat(),this.model.get("location").lng()]],directionAware:!1});this.currentPositionPoint=new suApp.view.PointLocationView({model:a,gmap:this.map,infoWindow:this.infoWindowView})},
handleMapZoomChange:function(){this.trigger("zoom_changed",this.map.getZoom())},updateMapPosition:function(){this.map.panTo(this.model.get("mapPosition"))},updateMapZoom:function(){this.map.setZoom(this.model.get("zoom"))},updateCurrentPosition:function(a){"undefined"===typeof this.currentPositionPoint&&(this.createPositionMarker(),this.currentPositionPoint.render());this.currentPositionPoint.model.set("coords",[[a.coords.latitude,a.coords.longitude]])},replacePoints:function(a){this.removeAllMarkers();
this.addMarkers(a)},removeAllMarkers:function(){_.each(this.pointViews,function(a){a.remove()});this.pointViews=[]},addMarkers:function(a){var b=this;a.each(function(a){var c=null,d=a.get("shape"),c="line"===d?new suApp.view.LineLocationView({model:a,gmap:b.map,infoWindow:b.infoWindowView}):"polygon"===d?new suApp.view.PolygonLocationView({model:a,gmap:b.map,infoWindow:b.infoWindowView}):new suApp.view.PointLocationView({model:a,gmap:b.map,infoWindow:b.infoWindowView});if(null!==a.getPin()&&("line"===
d||"polygon"===d))a=new suApp.view.PointLocationView({model:a,gmap:b.map,infoWindow:b.infoWindowView,customizedPosition:c.getCenter()}),b.pointViews.push(a);b.pointViews.push(c)});1===_.size(this.pointViews)&&(a=_.first(this.pointViews),a.openInfoWindow(a.model,a.marker))},getDirections:function(a,b){if(void 0==this.currentPositionPoint)"Android"==device.platform?showError(i18n.t("error.noGPSAndroid")):"iOS"==device.platform?showError(i18n.t("error.noGPSiOS")):showError(i18n.t("error.noGPS"));else{var f=
this.currentPositionPoint.getPosition(),c=null;"walking"===a?c=google.maps.DirectionsTravelMode.WALKING:"bicycling"===a?c=google.maps.DirectionsTravelMode.BICYCLING:"driving"===a?c=google.maps.DirectionsTravelMode.DRIVING:"publicTransp"===a&&(c=google.maps.DirectionsTravelMode.TRANSIT);var d=new google.maps.DirectionsService,e=new google.maps.DirectionsRenderer;e.setMap(this.map);e&&e.setPanel(document.getElementById("dir_panel"));d.route({origin:f,destination:b,travelMode:c},function(a,b){b==google.maps.DirectionsStatus.OK&&
e.setDirections(a)})}}});