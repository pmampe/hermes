suApp.view.AppView=Backbone.View.extend({initialize:function(a){_.bindAll(this,"render","locationCallback","campusCallback","menuSelectCallback","startGPSPositioning","handleZoomChanged","handleDeviceReady");$(document).on("deviceready.appview",this.handleDeviceReady);$(document).on("offline",this.handleNoNetworkConnectionMessage);var b=this;i18n.init({resGetPath:"../i18n/__lng__.json"},function(){b.$el.i18n();$("#search-box").i18n()});this.title=a.title;this.mapModel=new suApp.model.MapModel;var c=
this.model.get("filterByCampus"),d=this.model.get("menu"),e=this.model.get("types");this.mapView=new suApp.view.MapView({el:$("#map_canvas"),model:this.mapModel,appModel:this.model});this.searchView=new suApp.view.SearchView({el:$("#search-box"),collection:this.model.getFilterCollection(),placeholderSuffix:a.title?a.title.toLowerCase():void 0,types:e});this.searchView.on("selected",function(a){c?b.campusCallback(a):b.locationCallback(a)});this.mapView.on("zoom_changed",this.handleZoomChanged);this.model.on("change:campus",
this.changeCampus,this);this.model.locations.on("reset",function(){b.mapView.replacePoints(b.model.locations)});d&&(this.menuPopupView=new suApp.view.MenuPopupView({el:$("#menupopup"),campuses:this.model.campuses,appModel:this.model,searchView:this.searchView}),this.menuPopupView.on("selected",this.menuSelectCallback),this.changeCampus())},handleNoNetworkConnectionMessage:function(){showError(i18n.t("error.connectionlost"))},events:{"click #menubutton":"showMenu"},render:function(){$('div[data-role\x3d"header"] \x3e h1 \x3e span').attr("data-i18n",
this.title);$('div[data-role\x3d"header"]').i18n();!0===this.model.get("menu")&&($('div[data-role\x3d"header"]').append(JST["map/menu/button"]),$("#menubutton").button(),this.delegateEvents());this.mapView.render()},remove:function(){$(document).off(".appview");this.gpsWatchId&&navigator.geolocation&&navigator.geolocation.clearWatch(this.gpsWatchId);Backbone.View.prototype.remove.call(this)},locationCallback:function(a){a?(this.model.hideAllModelsExceptOne(a),a.trigger("click")):(this.model.handleLocationsReset(),
this.mapView.infoWindowView.close())},campusCallback:function(a){a&&this.model.set("campus",a)},menuSelectCallback:function(a){this.model.get("campus").id===a.id?(a=this.mapModel.get("mapPosition"),this.mapView.map.getCenter().equals(a)||(this.mapModel.setMapPosition(0,0),this.mapModel.setZoom(0)),this.changeCampus()):this.model.set("campus",a)},handleDeviceReady:function(){gaPlugin.trackPage(null,null,"map/index.html#"+Backbone.history.fragment);this.startGPSPositioning()},handleZoomChanged:function(a){!0===
this.model.get("zoomSensitive")&&(a>=suApp.config.map.zoom.threshold?this.trigger("toggleMarkerVisibility",this.model.locations,!0):a<suApp.config.map.zoom.threshold&&this.trigger("toggleMarkerVisibility",this.model.locations,!1))},showMenu:function(){this.menuPopupView.render()},updateLocations:function(){this.model.fetchLocations()},changeCampus:function(){var a=this.model.get("campus"),b=a.getLat(),c=a.getLng();this.mapModel.setMapPosition(b,c);this.mapModel.setZoom(a.getZoom())},getCurrentPosition:function(){var a=
this;this.gpsWatchId=navigator.geolocation.getCurrentPosition(function(b){a.mapView.trigger("updateCurrentPosition",b)},function(a){},{frequency:suApp.config.positionSettings.frequency,maximumAge:0,timeout:suApp.config.positionSettings.timeout,enableHighAccuracy:!0})},watchCurrentPosition:function(){var a=this;this.gpsWatchId=navigator.geolocation.watchPosition(function(b){a.mapView.trigger("updateCurrentPosition",b)},function(a){},{frequency:suApp.config.positionSettings.frequency,maximumAge:0,timeout:suApp.config.positionSettings.timeout,
enableHighAccuracy:!0})},startGPSPositioning:function(){navigator.geolocation&&(this.getCurrentPosition(),this.watchCurrentPosition())}});